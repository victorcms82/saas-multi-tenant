{
  "nodes": [
    {
      "parameters": {
        "url": "https://vnlfgnfaortdvmraoapq.supabase.co/rest/v1/rpc/get_location_staff_summary",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_inbox_id\": {{ $json.original_payload.body.inbox.id || $json.original_payload.inbox.id }}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubGZnbmZhb3J0ZHZtcmFvYXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MTM1NDgsImV4cCI6MjA3NzI4OTU0OH0.Qu6ithTk2tNNG-SYQDN5BP15pb_xKufOQUhqAuwxT0U"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubGZnbmZhb3J0ZHZtcmFvYXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MTM1NDgsImV4cCI6MjA3NzI4OTU0OH0.Qu6ithTk2tNNG-SYQDN5BP15pb_xKufOQUhqAuwxT0U"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "name": "üè¢ Detectar Localiza√ß√£o e Staff (RPC)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        24,
        0
      ],
      "id": "location-detection-rpc-node",
      "notes": "Chama get_location_staff_summary(inbox_id) para identificar:\n- Qual localiza√ß√£o/unidade (cl√≠nica, loja, etc)\n- Lista completa de profissionais dispon√≠veis\n- Hor√°rios, servi√ßos e especialidades\n\nRetorna TUDO em um √∫nico JSON para injetar no system prompt."
    },
    {
      "parameters": {
        "jsCode": "// Injetar dados de Location + Staff no contexto do workflow\nconst webhookData = $('Identificar Cliente e Agente').first().json;\nconst locationData = $input.first().json;\n\n// VALIDA√á√ÉO: Verificar se RPC retornou dados\nif (!locationData || locationData.length === 0) {\n  console.warn('‚ö†Ô∏è ATEN√á√ÉO: get_location_staff_summary n√£o retornou dados.');\n  console.warn('Poss√≠veis causas:');\n  console.warn('1. inbox_id n√£o est√° vinculado a nenhuma location na tabela locations');\n  console.warn('2. location est√° com is_active = FALSE');\n  console.warn('3. inbox_id n√£o foi passado corretamente');\n  \n  // Continuar workflow SEM dados de location (fallback)\n  return {\n    json: {\n      ...webhookData,\n      location_context: null,\n      has_location_data: false,\n      location_error: 'No location found for this inbox_id'\n    }\n  };\n}\n\n// Extrair primeiro resultado (sempre retorna array com 1 item)\nconst location = locationData[0] || locationData;\n\nconsole.log('‚úÖ Localiza√ß√£o detectada:', location.location_name);\nconsole.log('üìä Total de profissionais:', location.total_staff);\nconsole.log('‚úÖ Dispon√≠veis online:', location.staff_available_online);\n\n// Construir contexto formatado para o LLM\nconst locationContext = `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüè¢ INFORMA√á√ïES DA UNIDADE\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nNome: ${location.location_name}\nTipo: ${location.location_type}\nEndere√ßo: ${location.address}, ${location.city}\nTelefone: ${location.phone}\nWhatsApp: ${location.whatsapp_number}\n\nHor√°rio de Funcionamento:\n${formatWorkingHours(location.working_hours)}\n\nServi√ßos Oferecidos:\n${formatServices(location.services_offered)}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë• PROFISSIONAIS DISPON√çVEIS (${location.staff_available_online}/${location.total_staff})\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${formatStaffList(location.staff_list)}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;\n\n// Fun√ß√µes auxiliares de formata√ß√£o\nfunction formatWorkingHours(hours) {\n  if (!hours || hours.length === 0) return 'N√£o informado';\n  \n  const dayNames = {\n    monday: 'Segunda',\n    tuesday: 'Ter√ßa',\n    wednesday: 'Quarta',\n    thursday: 'Quinta',\n    friday: 'Sexta',\n    saturday: 'S√°bado',\n    sunday: 'Domingo'\n  };\n  \n  return hours.map(h => \n    `  ‚Ä¢ ${dayNames[h.day] || h.day}: ${h.start} √†s ${h.end}`\n  ).join('\\n');\n}\n\nfunction formatServices(services) {\n  if (!services || services.length === 0) return 'N√£o informado';\n  return services.map(s => `  ‚Ä¢ ${s}`).join('\\n');\n}\n\nfunction formatStaffList(staffList) {\n  if (!staffList || staffList.length === 0) return 'Nenhum profissional dispon√≠vel no momento.';\n  \n  return staffList.map((staff, index) => {\n    const featured = staff.is_featured ? '‚≠ê ' : '';\n    const rating = staff.rating ? ` (${staff.rating}‚≠ê)` : '';\n    const services = staff.services && staff.services.length > 0 \n      ? `\\n    Servi√ßos: ${staff.services.join(', ')}`\n      : '';\n    const days = staff.available_days && staff.available_days.length > 0\n      ? `\\n    Dispon√≠vel: ${formatDays(staff.available_days)}`\n      : '';\n    const duration = staff.appointment_duration\n      ? `\\n    Dura√ß√£o consulta: ${staff.appointment_duration} minutos`\n      : '';\n    const bio = staff.bio\n      ? `\\n    ${staff.bio}`\n      : '';\n    \n    return `\n${index + 1}. ${featured}${staff.name}${rating}\n   ${staff.specialty || staff.role}${services}${days}${duration}${bio}\n`;\n  }).join('\\n');\n}\n\nfunction formatDays(days) {\n  const dayNames = {\n    monday: 'Seg',\n    tuesday: 'Ter',\n    wednesday: 'Qua',\n    thursday: 'Qui',\n    friday: 'Sex',\n    saturday: 'S√°b',\n    sunday: 'Dom'\n  };\n  return days.map(d => dayNames[d] || d).join(', ');\n}\n\n// Retornar contexto enriquecido\nreturn {\n  json: {\n    ...webhookData,\n    location_id: location.location_id,\n    location_name: location.location_name,\n    location_type: location.location_type,\n    location_address: location.address,\n    location_city: location.city,\n    location_phone: location.phone,\n    location_whatsapp: location.whatsapp_number,\n    location_working_hours: location.working_hours,\n    location_services: location.services_offered,\n    staff_total: location.total_staff,\n    staff_available: location.staff_available_online,\n    staff_list: location.staff_list,\n    location_context: locationContext,\n    has_location_data: true,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "name": "üíº Construir Contexto Location + Staff",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        0
      ],
      "id": "build-location-context-node",
      "notes": "Formata os dados retornados pelo RPC em um texto leg√≠vel para o LLM.\n\nInclui:\n- Informa√ß√µes da unidade (endere√ßo, telefone, hor√°rios)\n- Lista de profissionais com especialidades\n- Disponibilidade por dia da semana\n- Servi√ßos oferecidos por cada um\n\nEsse contexto ser√° injetado no system prompt para o LLM saber:\n- De qual unidade √© a conversa\n- Quais profissionais pode oferecer\n- Quando cada um est√° dispon√≠vel"
    }
  ],
  "connections": {
    "üè¢ Detectar Localiza√ß√£o e Staff (RPC)": {
      "main": [
        [
          {
            "node": "üíº Construir Contexto Location + Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "instructions": {
    "title": "üìç INSTRU√á√ïES DE INSTALA√á√ÉO - Nodes Multi-Location Detection",
    "description": "Estes 2 nodes devem ser inseridos ENTRE 'Filtrar Apenas Incoming' e 'Buscar Dados do Agente (HTTP)'",
    "steps": [
      {
        "step": 1,
        "action": "Abra o workflow 'WF0-Gestor-Universal-FINAL-CORRIGIDO' no n8n"
      },
      {
        "step": 2,
        "action": "Importe este JSON (Settings ‚Üí Import from File ou Clipboard)"
      },
      {
        "step": 3,
        "action": "Conecte os nodes na seguinte ordem:",
        "connections": [
          "'Filtrar Apenas Incoming' (sa√≠da TRUE) ‚Üí 'üè¢ Detectar Localiza√ß√£o e Staff (RPC)'",
          "'üè¢ Detectar Localiza√ß√£o e Staff (RPC)' ‚Üí 'üíº Construir Contexto Location + Staff'",
          "'üíº Construir Contexto Location + Staff' ‚Üí 'Buscar Dados do Agente (HTTP)'"
        ]
      },
      {
        "step": 4,
        "action": "Atualizar o node 'Construir Contexto Completo'",
        "details": "Adicione esta linha no in√≠cio do c√≥digo JavaScript:",
        "code": "const locationContext = item.location_context || '';"
      },
      {
        "step": 5,
        "action": "No mesmo node 'Construir Contexto Completo', na vari√°vel fullContext, adicione:",
        "code": "const fullContext = `${baseContext}\\n\\n${locationContext}\\n\\n${mediaContext}`;"
      },
      {
        "step": 6,
        "action": "IMPORTANTE: Configurar chatwoot_inbox_id nas locations",
        "warning": "As 4 locations precisam ter o campo 'chatwoot_inbox_id' preenchido com o ID real do inbox do Chatwoot.",
        "sql": "UPDATE locations SET chatwoot_inbox_id = 123456 WHERE location_id = 'bella_barra_001';"
      },
      {
        "step": 7,
        "action": "Salve e teste o workflow enviando uma mensagem pelo Chatwoot"
      }
    ],
    "validation": {
      "test1": "Envie uma mensagem qualquer no Chatwoot",
      "expected1": "O node 'üè¢ Detectar Localiza√ß√£o' deve retornar dados da location",
      "test2": "Verifique o output do node 'üíº Construir Contexto'",
      "expected2": "Deve mostrar texto formatado com nome da unidade e lista de profissionais"
    },
    "troubleshooting": {
      "error1": "RPC retorna array vazio",
      "solution1": "Verifique se chatwoot_inbox_id est√° configurado na tabela locations",
      "error2": "Node falha com erro 'inbox.id is undefined'",
      "solution2": "Verifique a estrutura do payload do Chatwoot no node 'Identificar Cliente e Agente'",
      "error3": "Context n√£o aparece no LLM",
      "solution3": "Certifique-se de atualizar o node 'Construir Contexto Completo' conforme step 4 e 5"
    }
  },
  "metadata": {
    "version": "1.0.0",
    "created_at": "2025-11-11",
    "author": "GitHub Copilot",
    "description": "Nodes para detectar localiza√ß√£o multi-tenant e injetar contexto de staff no system prompt",
    "dependencies": [
      "Migration 011: locations table",
      "Migration 012: staff table",
      "Migration 013: RPCs (get_location_staff_summary)"
    ],
    "features": [
      "Detec√ß√£o autom√°tica de localiza√ß√£o via inbox_id",
      "Lista de profissionais dispon√≠veis",
      "Formata√ß√£o de contexto para LLM",
      "Fallback para casos sem location configurada",
      "Logging detalhado para debug"
    ]
  }
}
