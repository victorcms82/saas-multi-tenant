<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Manager - Upload e Gerenciamento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .documents-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .document-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .document-item h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .document-item p {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .document-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 12px;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .settings {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .settings h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö RAG Manager</h1>
            <p class="subtitle">Gerencie documentos da base de conhecimento do seu assistente</p>
        </div>

        <!-- Configura√ß√µes -->
        <div class="card">
            <h2>‚öôÔ∏è Configura√ß√£o</h2>
            <div class="settings">
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="clientId" placeholder="clinica_sorriso_001" value="clinica_sorriso_001">
                </div>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="agentId" placeholder="default" value="default">
                </div>
                <div class="form-group">
                    <label>Supabase URL</label>
                    <input type="text" id="supabaseUrl" value="https://vnlfgnfaortdvmraoapq.supabase.co">
                </div>
                <div class="form-group">
                    <label>Supabase Key (Service Role)</label>
                    <input type="password" id="supabaseKey" placeholder="Cole sua service role key aqui">
                </div>
                <div class="form-group">
                    <label>OpenAI API Key</label>
                    <input type="password" id="openaiKey" placeholder="sk-proj-...">
                </div>
                <button class="btn btn-secondary" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
            </div>
        </div>

        <div class="grid">
            <!-- Upload de Documento -->
            <div class="card">
                <h2>üì§ Upload de Documento</h2>
                
                <div class="form-group">
                    <label>M√©todo de Upload</label>
                    <select id="uploadMethod" onchange="toggleUploadMethod()">
                        <option value="text">Texto Direto</option>
                        <option value="file">Upload de Arquivo</option>
                    </select>
                </div>

                <div id="textUpload">
                    <div class="form-group">
                        <label>Nome do Arquivo</label>
                        <input type="text" id="fileName" placeholder="manual-servicos.txt">
                    </div>
                    <div class="form-group">
                        <label>Conte√∫do</label>
                        <textarea id="content" placeholder="Cole o conte√∫do do documento aqui..."></textarea>
                    </div>
                </div>

                <div id="fileUpload" style="display: none;">
                    <div class="form-group">
                        <label>Selecionar Arquivo (TXT, MD)</label>
                        <input type="file" id="fileInput" accept=".txt,.md">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tags (separadas por v√≠rgula)</label>
                    <input type="text" id="tags" placeholder="pre√ßos, servi√ßos, 2025">
                </div>

                <button class="btn" onclick="uploadDocument()">
                    üì§ Fazer Upload
                </button>

                <div id="uploadStatus" class="status"></div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="card">
                <h2>üìä Estat√≠sticas</h2>
                <div class="stats">
                    <div class="stat-box">
                        <h3 id="totalDocs">-</h3>
                        <p>Documentos</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="totalChunks">-</h3>
                        <p>Chunks</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="avgSize">-</h3>
                        <p>Tamanho M√©dio</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="loadStatistics()" style="margin-top: 15px;">
                    üîÑ Atualizar Estat√≠sticas
                </button>
            </div>
        </div>

        <!-- Lista de Documentos -->
        <div class="card">
            <h2>üìã Documentos Cadastrados</h2>
            <button class="btn btn-secondary" onclick="loadDocuments()">üîÑ Carregar Documentos</button>
            <div id="documentsList" class="documents-list"></div>
        </div>

        <!-- Testar Query -->
        <div class="card">
            <h2>üîç Testar Query RAG</h2>
            <div class="form-group">
                <label>Pergunta de Teste</label>
                <input type="text" id="testQuery" placeholder="Quanto custa um clareamento dental?">
            </div>
            <button class="btn" onclick="testQuery()">üîç Buscar Documentos Relevantes</button>
            <div id="queryStatus" class="status"></div>
            <div id="queryResults"></div>
        </div>
    </div>

    <script>
        // Carregar configura√ß√µes salvas
        function loadSettings() {
            const saved = localStorage.getItem('ragSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('clientId').value = settings.clientId || 'clinica_sorriso_001';
                document.getElementById('agentId').value = settings.agentId || 'default';
                document.getElementById('supabaseUrl').value = settings.supabaseUrl || '';
                document.getElementById('supabaseKey').value = settings.supabaseKey || '';
                document.getElementById('openaiKey').value = settings.openaiKey || '';
            }
        }

        function saveSettings() {
            const settings = {
                clientId: document.getElementById('clientId').value,
                agentId: document.getElementById('agentId').value,
                supabaseUrl: document.getElementById('supabaseUrl').value,
                supabaseKey: document.getElementById('supabaseKey').value,
                openaiKey: document.getElementById('openaiKey').value
            };
            localStorage.setItem('ragSettings', JSON.stringify(settings));
            showStatus('uploadStatus', 'Configura√ß√µes salvas com sucesso!', 'success');
        }

        function toggleUploadMethod() {
            const method = document.getElementById('uploadMethod').value;
            document.getElementById('textUpload').style.display = method === 'text' ? 'block' : 'none';
            document.getElementById('fileUpload').style.display = method === 'file' ? 'block' : 'none';
        }

        function showStatus(elementId, message, type) {
            const status = document.getElementById(elementId);
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        async function uploadDocument() {
            const clientId = document.getElementById('clientId').value;
            const agentId = document.getElementById('agentId').value;
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            const openaiKey = document.getElementById('openaiKey').value;

            if (!supabaseKey || !openaiKey) {
                showStatus('uploadStatus', '‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            let content, fileName;
            const method = document.getElementById('uploadMethod').value;

            if (method === 'text') {
                content = document.getElementById('content').value;
                fileName = document.getElementById('fileName').value;
            } else {
                const file = document.getElementById('fileInput').files[0];
                if (!file) {
                    showStatus('uploadStatus', '‚ùå Selecione um arquivo!', 'error');
                    return;
                }
                content = await file.text();
                fileName = file.name;
            }

            if (!content.trim()) {
                showStatus('uploadStatus', '‚ùå Conte√∫do vazio!', 'error');
                return;
            }

            const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);

            showStatus('uploadStatus', 'üîÑ Processando documento...', 'info');

            try {
                // Dividir em chunks
                const chunks = splitIntoChunks(content, 2000, 200);
                showStatus('uploadStatus', `‚úÇÔ∏è Dividido em ${chunks.length} chunks. Gerando embeddings...`, 'info');

                let successCount = 0;

                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    
                    // Gerar embedding
                    const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${openaiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'text-embedding-ada-002',
                            input: chunk
                        })
                    });

                    if (!embeddingResponse.ok) {
                        throw new Error('Erro ao gerar embedding');
                    }

                    const embeddingData = await embeddingResponse.json();
                    const embedding = embeddingData.data[0].embedding;

                    // Gerar hash MD5
                    const contentHash = await md5(chunk);

                    // Salvar no Supabase
                    const saveResponse = await fetch(`${supabaseUrl}/rest/v1/rpc/save_rag_document`, {
                        method: 'POST',
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            p_client_id: clientId,
                            p_agent_id: agentId,
                            p_content: chunk,
                            p_content_hash: contentHash,
                            p_embedding: embedding,
                            p_metadata: { tags, upload_via: 'web' },
                            p_source_type: 'manual',
                            p_source_id: fileName,
                            p_source_url: null,
                            p_file_name: fileName,
                            p_chunk_index: i,
                            p_total_chunks: chunks.length
                        })
                    });

                    if (saveResponse.ok) {
                        successCount++;
                        showStatus('uploadStatus', `‚úÖ Chunk ${i+1}/${chunks.length} enviado...`, 'info');
                    }
                }

                showStatus('uploadStatus', `üéâ Upload conclu√≠do! ${successCount}/${chunks.length} chunks salvos.`, 'success');
                
                // Limpar formul√°rio
                document.getElementById('content').value = '';
                document.getElementById('fileName').value = '';
                document.getElementById('tags').value = '';
                
                // Atualizar estat√≠sticas
                loadStatistics();

            } catch (error) {
                showStatus('uploadStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        function splitIntoChunks(text, chunkSize, overlap) {
            const chunks = [];
            let start = 0;
            while (start < text.length) {
                const end = Math.min(start + chunkSize, text.length);
                chunks.push(text.substring(start, end));
                start += (chunkSize - overlap);
            }
            return chunks;
        }

        async function md5(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function loadStatistics() {
            const clientId = document.getElementById('clientId').value;
            const agentId = document.getElementById('agentId').value;
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;

            try {
                const response = await fetch(
                    `${supabaseUrl}/rest/v1/rag_statistics?client_id=eq.${clientId}&agent_id=eq.${agentId}`,
                    {
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`
                        }
                    }
                );

                const data = await response.json();
                if (data && data.length > 0) {
                    const stats = data[0];
                    document.getElementById('totalDocs').textContent = stats.unique_sources || 0;
                    document.getElementById('totalChunks').textContent = stats.total_documents || 0;
                    document.getElementById('avgSize').textContent = 
                        stats.avg_chunk_size ? Math.round(stats.avg_chunk_size) + ' chars' : '-';
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        async function loadDocuments() {
            const clientId = document.getElementById('clientId').value;
            const agentId = document.getElementById('agentId').value;
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;

            const list = document.getElementById('documentsList');
            list.innerHTML = '<p style="text-align: center; color: #666;">Carregando...</p>';

            try {
                const response = await fetch(
                    `${supabaseUrl}/rest/v1/rag_documents?client_id=eq.${clientId}&agent_id=eq.${agentId}&select=*&order=created_at.desc&limit=50`,
                    {
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`
                        }
                    }
                );

                const docs = await response.json();
                
                if (docs.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #666;">Nenhum documento encontrado</p>';
                    return;
                }

                // Agrupar por arquivo
                const grouped = {};
                docs.forEach(doc => {
                    if (!grouped[doc.file_name]) {
                        grouped[doc.file_name] = [];
                    }
                    grouped[doc.file_name].push(doc);
                });

                list.innerHTML = Object.entries(grouped).map(([fileName, chunks]) => `
                    <div class="document-item">
                        <h4>üìÑ ${fileName}</h4>
                        <p>
                            ${chunks.length} chunk(s) ‚Ä¢ 
                            ${chunks[0].metadata?.tags ? chunks[0].metadata.tags.join(', ') : 'Sem tags'} ‚Ä¢ 
                            ${new Date(chunks[0].created_at).toLocaleDateString('pt-BR')}
                        </p>
                        <div class="document-actions">
                            <button class="btn btn-secondary" onclick="viewDocument('${chunks[0].source_id}')">üëÅÔ∏è Ver</button>
                            <button class="btn btn-danger" onclick="deleteDocument('${chunks[0].source_id}')">üóëÔ∏è Deletar</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                list.innerHTML = `<p style="text-align: center; color: #ef4444;">Erro: ${error.message}</p>`;
            }
        }

        async function deleteDocument(sourceId) {
            if (!confirm(`Tem certeza que deseja deletar este documento?\n\nArquivo: ${sourceId}`)) {
                return;
            }

            const clientId = document.getElementById('clientId').value;
            const agentId = document.getElementById('agentId').value;
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;

            try {
                const response = await fetch(`${supabaseUrl}/rest/v1/rpc/delete_rag_documents_by_source`, {
                    method: 'POST',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_client_id: clientId,
                        p_agent_id: agentId,
                        p_source_id: sourceId
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Documento deletado com sucesso!');
                    loadDocuments();
                    loadStatistics();
                }
            } catch (error) {
                alert(`‚ùå Erro ao deletar: ${error.message}`);
            }
        }

        async function testQuery() {
            const query = document.getElementById('testQuery').value;
            const clientId = document.getElementById('clientId').value;
            const agentId = document.getElementById('agentId').value;
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            const openaiKey = document.getElementById('openaiKey').value;

            if (!query.trim()) {
                showStatus('queryStatus', '‚ùå Digite uma pergunta!', 'error');
                return;
            }

            showStatus('queryStatus', 'üîÑ Gerando embedding e buscando...', 'info');

            try {
                // Gerar embedding
                const embeddingResponse = await fetch('https://api.openai.com/v1/embeddings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'text-embedding-ada-002',
                        input: query
                    })
                });

                const embeddingData = await embeddingResponse.json();
                const embedding = embeddingData.data[0].embedding;

                // Buscar documentos
                const queryResponse = await fetch(`${supabaseUrl}/rest/v1/rpc/query_rag_documents`, {
                    method: 'POST',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_client_id: clientId,
                        p_agent_id: agentId,
                        p_query_embedding: embedding,
                        p_limit: 5,
                        p_threshold: 0.7
                    })
                });

                const results = await queryResponse.json();

                if (results.length === 0) {
                    showStatus('queryStatus', '‚ö†Ô∏è Nenhum documento relevante encontrado (similaridade < 70%)', 'info');
                    document.getElementById('queryResults').innerHTML = '';
                    return;
                }

                showStatus('queryStatus', `‚úÖ ${results.length} documento(s) encontrado(s)!`, 'success');
                
                document.getElementById('queryResults').innerHTML = results.map((doc, i) => `
                    <div class="document-item" style="margin-top: 15px;">
                        <h4>${i+1}. ${doc.file_name} - Relev√¢ncia: ${(doc.similarity * 100).toFixed(0)}%</h4>
                        <p style="white-space: pre-wrap; font-family: monospace; font-size: 12px; margin-top: 10px;">${doc.content}</p>
                    </div>
                `).join('');

            } catch (error) {
                showStatus('queryStatus', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        function viewDocument(sourceId) {
            alert(`Funcionalidade "Ver Documento" ser√° implementada em breve!\n\nSource ID: ${sourceId}`);
        }

        // Carregar configura√ß√µes ao iniciar
        loadSettings();
        loadStatistics();
    </script>
</body>
</html>
