name: Run Supabase Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'database/migrations/**'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run Migration 001
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸš€ Migration 001: Creating agents table..."
          
          # Construct connection string
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-0-us-east-1.pooler.supabase.com:6543/postgres"
          
          # Run migration
          psql "$DB_URL" -f database/migrations/001_add_agents_table_CUSTOM.sql
          
          echo "âœ… Migration 001 completed!"

      - name: Run Migration 002
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸª Migration 002: Creating marketplace tables..."
          
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-0-us-east-1.pooler.supabase.com:6543/postgres"
          
          psql "$DB_URL" -f database/migrations/002_add_marketplace_tables.sql
          
          echo "âœ… Migration 002 completed!"

      - name: Run Migration 003 - Validation
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸ” Migration 003: Validating system integrity..."
          
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-0-us-east-1.pooler.supabase.com:6543/postgres"
          
          psql "$DB_URL" -f database/migrations/003_validate_system.sql
          
          echo "âœ… Validation completed!"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All migrations completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š What was created:"
          echo "  â€¢ Table: agents (multi-agent support)"
          echo "  â€¢ Tables: 6 marketplace tables"
          echo "  â€¢ Templates: 4 initial templates"
          echo "  â€¢ Functions: 12 business functions"
          echo "  â€¢ Views: 4 useful views (including profitability)"
          echo ""
          echo "ğŸ¯ Next: Test queries in Supabase SQL Editor"
