# ğŸ¨ Diagramas de Arquitetura - Plataforma SaaS Multi-Tenant

## ğŸ“Š VisÃ£o Geral do Sistema (Arquitetura Chatwoot Hub)

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚      USUÃRIO FINAL              â”‚
                                    â”‚  (Cliente do seu cliente)       â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                        â”‚                        â”‚
                        â–¼                        â–¼                        â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚    WhatsApp      â”‚    â”‚   Instagram      â”‚    â”‚     Email        â”‚
             â”‚ Evolution/Meta   â”‚    â”‚  (Meta Graph)    â”‚    â”‚    (SMTP)        â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                       â”‚                       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚       CHATWOOT (HUB CENTRAL)            â”‚
                            â”‚  - Unifica todos os canais              â”‚
                            â”‚  - Dashboard Ãºnico                      â”‚
                            â”‚  - Handoff humano                       â”‚
                            â”‚  - HistÃ³rico centralizado               â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚         n8n WEBHOOK             â”‚
                            â”‚     /webhook/chatwoot           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚                    â”‚
                    â–¼                    â–¼                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Supabase       â”‚ â”‚     Redis        â”‚ â”‚  Google Vertex   â”‚
         â”‚ (Config + Logs)  â”‚ â”‚ (Buffer+Memory)  â”‚ â”‚      AI          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¢ Arquitetura Multi-Tenant: MÃºltiplos Agentes por Cliente

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INFRAESTRUTURA ÃšNICA                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   n8n    â”‚  â”‚ Supabase â”‚  â”‚  Redis   â”‚  â”‚ Chatwoot â”‚       â”‚
â”‚  â”‚  v1.118  â”‚  â”‚   +RAG   â”‚  â”‚  Cache   â”‚  â”‚  v4.7.0  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                   â”‚                   â”‚
           â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CLIENTE A  â”‚    â”‚  CLIENTE B  â”‚    â”‚  CLIENTE C  â”‚
    â”‚ acme-corp   â”‚    â”‚dentista-sp  â”‚    â”‚ loja-moda   â”‚
    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
    â”‚ 3 AGENTES:  â”‚    â”‚ 1 AGENTE:   â”‚    â”‚ 2 AGENTES:  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
    â”‚ 1ï¸âƒ£ SDR      â”‚    â”‚ 1ï¸âƒ£ RecepÃ§Ã£o â”‚    â”‚ 1ï¸âƒ£ Vendas   â”‚
    â”‚ "Lucas"     â”‚    â”‚ "Dra. Ana"  â”‚    â”‚ "Maria"     â”‚
    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
    â”‚ Canais:     â”‚    â”‚ Canais:     â”‚    â”‚ Canais:     â”‚
    â”‚ â€¢ WhatsApp  â”‚    â”‚ â€¢ WhatsApp  â”‚    â”‚ â€¢ WhatsApp  â”‚
    â”‚ â€¢ Instagram â”‚    â”‚             â”‚    â”‚ â€¢ Instagram â”‚
    â”‚             â”‚    â”‚ Tools:      â”‚    â”‚             â”‚
    â”‚ Tools:      â”‚    â”‚ â€¢ RAG       â”‚    â”‚ Tools:      â”‚
    â”‚ â€¢ RAG       â”‚    â”‚ â€¢ Feegow    â”‚    â”‚ â€¢ RAG       â”‚
    â”‚ â€¢ Calendar  â”‚    â”‚             â”‚    â”‚ â€¢ Image Gen â”‚
    â”‚ â€¢ CRM       â”‚    â”‚ LLM:        â”‚    â”‚ â€¢ Payments  â”‚
    â”‚             â”‚    â”‚ Gemini      â”‚    â”‚             â”‚
    â”‚ LLM:        â”‚    â”‚ Flash       â”‚    â”‚ LLM:        â”‚
    â”‚ Gemini      â”‚    â”‚             â”‚    â”‚ GPT-4       â”‚
    â”‚ Flash       â”‚    â”‚ Rate:       â”‚    â”‚ Turbo       â”‚
    â”‚             â”‚    â”‚ 60/min      â”‚    â”‚             â”‚
    â”‚ Rate:       â”‚    â”‚             â”‚    â”‚ Rate:       â”‚
    â”‚ 200/min     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ 500/min     â”‚
    â”‚             â”‚                       â”‚             â”‚
    â”‚ 2ï¸âƒ£ Suporte  â”‚                       â”‚ 2ï¸âƒ£ SAC      â”‚
    â”‚ "Ana"       â”‚                       â”‚ "Carlos"    â”‚
    â”‚             â”‚                       â”‚             â”‚
    â”‚ Canais:     â”‚                       â”‚ Canais:     â”‚
    â”‚ â€¢ Chatwoot  â”‚                       â”‚ â€¢ Chatwoot  â”‚
    â”‚ â€¢ Email     â”‚                       â”‚             â”‚
    â”‚             â”‚                       â”‚ Tools:      â”‚
    â”‚ Tools:      â”‚                       â”‚ â€¢ RAG       â”‚
    â”‚ â€¢ RAG       â”‚                       â”‚             â”‚
    â”‚ â€¢ Tickets   â”‚                       â”‚ LLM:        â”‚
    â”‚             â”‚                       â”‚ Gemini      â”‚
    â”‚ LLM:        â”‚                       â”‚ Flash       â”‚
    â”‚ Gemini      â”‚                       â”‚             â”‚
    â”‚ Flash       â”‚                       â”‚ Rate:       â”‚
    â”‚             â”‚                       â”‚ 100/min     â”‚
    â”‚ Rate:       â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ 100/min     â”‚
    â”‚             â”‚
    â”‚ 3ï¸âƒ£ CobranÃ§a â”‚
    â”‚ "Roberto"   â”‚
    â”‚             â”‚
    â”‚ Canais:     â”‚
    â”‚ â€¢ WhatsApp  â”‚
    â”‚ â€¢ Email     â”‚
    â”‚             â”‚
    â”‚ Tools:      â”‚
    â”‚ â€¢ RAG       â”‚
    â”‚ â€¢ Payments  â”‚
    â”‚             â”‚
    â”‚ LLM:        â”‚
    â”‚ Gemini      â”‚
    â”‚ Flash       â”‚
    â”‚             â”‚
    â”‚ Rate:       â”‚
    â”‚ 60/min      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL: 3 clientes â†’ 6 agentes â†’ 1 infraestrutura!
```

### Isolamento de Dados por Cliente e Agente

```
Supabase (PostgreSQL):
â”œâ”€ clients (conta do cliente)
â”‚  â”œâ”€ acme-corp: {max_agents: 5, active: 3}
â”‚  â”œâ”€ dentista-sp: {max_agents: 1, active: 1}
â”‚  â””â”€ loja-moda: {max_agents: 3, active: 2}
â”‚
â”œâ”€ agents (agentes individuais)
â”‚  â”œâ”€ acme-corp/sdr: {system_prompt: "SDR Lucas...", tools: [rag, calendar, crm]}
â”‚  â”œâ”€ acme-corp/suporte: {system_prompt: "Suporte Ana...", tools: [rag, tickets]}
â”‚  â”œâ”€ acme-corp/cobranca: {system_prompt: "CobranÃ§a Roberto...", tools: [rag, payments]}
â”‚  â”œâ”€ dentista-sp/recepcao: {system_prompt: "Dra. Ana...", tools: [rag, feegow]}
â”‚  â”œâ”€ loja-moda/vendas: {system_prompt: "Vendedora Maria...", tools: [rag, image_gen]}
â”‚  â””â”€ loja-moda/sac: {system_prompt: "SAC Carlos...", tools: [rag]}
â”‚
â”œâ”€ rag_documents (base conhecimento isolada)
â”‚  â”œâ”€ acme-corp/sdr â†’ 2.500 chunks (produtos, preÃ§os)
â”‚  â”œâ”€ acme-corp/suporte â†’ 1.800 chunks (troubleshooting)
â”‚  â”œâ”€ acme-corp/cobranca â†’ 300 chunks (polÃ­ticas)
â”‚  â”œâ”€ dentista-sp/recepcao â†’ 500 chunks (procedimentos)
â”‚  â”œâ”€ loja-moda/vendas â†’ 1.200 chunks (catÃ¡logo)
â”‚  â””â”€ loja-moda/sac â†’ 600 chunks (FAQ)
â”‚
â”œâ”€ agent_executions (logs por agente)
â”‚  â”œâ”€ acme-corp/sdr â†’ 15.234 execuÃ§Ãµes
â”‚  â”œâ”€ acme-corp/suporte â†’ 8.901 execuÃ§Ãµes
â”‚  â””â”€ ... (todas isoladas)
â”‚
â””â”€ client_usage (billing agregado por cliente)
   â”œâ”€ acme-corp â†’ $18.45 (soma dos 3 agentes)
   â”œâ”€ dentista-sp â†’ $2.45
   â””â”€ loja-moda â†’ $12.30
```

### Roteamento Inteligente

```
Mensagem recebida â†’ Chatwoot Inbox â†’ Detecta agente:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inbox: "WhatsApp Vendas Acme"                                â”‚
â”‚ Custom Attributes:                                           â”‚
â”‚   client_id: "acme-corp"                                     â”‚
â”‚   agent_id: "sdr"                           â† Roteamento!    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              WF-0 carrega config:
              agents.client_id = 'acme-corp'
              agents.agent_id = 'sdr'
                       â†“
            System Prompt: "VocÃª Ã© Lucas, SDR..."
            Tools: ["rag", "calendar", "crm"]
            RAG Namespace: "acme-corp-sdr-rag"
```

---

## ğŸ”„ Fluxo Detalhado do WF 0

### Fase 1: RecepÃ§Ã£o & ValidaÃ§Ã£o
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. WEBHOOK TRIGGER (Chatwoot)                                      â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ POST /webhook/chatwoot                                              â”‚
â”‚                                                                     â”‚
â”‚ Body (Chatwoot Format):                                             â”‚
â”‚ {                                                                   â”‚
â”‚   "event": "message_created",                                       â”‚
â”‚   "inbox": {"id": 5, "name": "WhatsApp Vendas"},                   â”‚
â”‚   "conversation": {                                                 â”‚
â”‚     "id": 123,                                                      â”‚
â”‚     "custom_attributes": {                                          â”‚
â”‚       "client_id": "acme-corp",                                     â”‚
â”‚       "agent_id": "sdr"             â† MÃºltiplos agentes!            â”‚
â”‚     }                                                               â”‚
â”‚   },                                                                â”‚
â”‚   "sender": {"name": "JoÃ£o", "phone": "+5521999999999"},           â”‚
â”‚   "content": "OlÃ¡, quero saber sobre preÃ§os",                      â”‚
â”‚   "content_type": "text",                                           â”‚
â”‚   "attachments": []                 â† Suporte a mÃ­dia               â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. EXTRACT & VALIDATE (Chatwoot-First)                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ âœ“ Validar evento Chatwoot (message_created)                        â”‚
â”‚ âœ“ Extrair client_id e agent_id dos custom_attributes               â”‚
â”‚ âœ“ Detectar tipo de mÃ­dia (text/audio/image/file)                   â”‚
â”‚ âœ“ Criar estrutura unificada                                        â”‚
â”‚                                                                     â”‚
â”‚ Output:                                                             â”‚
â”‚ {                                                                   â”‚
â”‚   client_id: "acme-corp",                                           â”‚
â”‚   agent_id: "sdr",                 â† Novo!                          â”‚
â”‚   conversation_id: "123",                                           â”‚
â”‚   user_message: "OlÃ¡, quero saber sobre preÃ§os",                   â”‚
â”‚   user_message_type: "text",       â† Detecta tipo                  â”‚
â”‚   user_attachments: [],            â† Array de mÃ­dias                â”‚
â”‚   inbox_id: 5,                                                      â”‚
â”‚   timestamp: "2025-11-06T21:30:00Z"                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PROCESS MEDIA INPUT (se houver)                                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ ğŸ¤ Se ÃUDIO:                                                        â”‚
â”‚    â†’ Download do attachment                                         â”‚
â”‚    â†’ Google Speech-to-Text (transcriÃ§Ã£o)                           â”‚
â”‚    â†’ user_message = texto transcrito                                â”‚
â”‚    â†’ Custo: $0.006/min                                              â”‚
â”‚                                                                     â”‚
â”‚ ğŸ–¼ï¸ Se IMAGEM:                                                       â”‚
â”‚    â†’ Download do attachment                                         â”‚
â”‚    â†’ Preparar para Gemini Vision                                   â”‚
â”‚    â†’ image_data = {base64, mimeType}                                â”‚
â”‚    â†’ supports_vision = true                                         â”‚
â”‚                                                                     â”‚
â”‚ ğŸ“„ Se DOCUMENTO (PDF/DOCX):                                         â”‚
â”‚    â†’ Download do attachment                                         â”‚
â”‚    â†’ Extrair texto (pdf-parse/mammoth.js)                          â”‚
â”‚    â†’ user_message = "[Doc: nome.pdf]\n" + texto                     â”‚
â”‚                                                                     â”‚
â”‚ ğŸ¥ Se VÃDEO:                                                        â”‚
â”‚    â†’ Upload para Google Cloud Storage                              â”‚
â”‚    â†’ video_url = gs://bucket/video.mp4                              â”‚
â”‚    â†’ supports_video = true                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RATE LIMIT CHECK (Supabase)                                     â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ SELECT check_and_increment_rate_limit('acme-corp', 500)            â”‚
â”‚                                                                     â”‚
â”‚ VerificaÃ§Ãµes:                                                       â”‚
â”‚ âœ“ Requests/minuto: 45/60 âœ…                                         â”‚
â”‚ âœ“ Requests/dia: 1523/10000 âœ…                                       â”‚
â”‚ âœ“ Tokens/mÃªs: 850000/1000000 âœ…                                     â”‚
â”‚                                                                     â”‚
â”‚ Result: {"allowed": true}                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. LOAD AGENT CONFIG (Supabase)                                    â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ SELECT * FROM agents                                                â”‚
â”‚ WHERE client_id = 'acme-corp'                                       â”‚
â”‚   AND agent_id = 'sdr'              â† Agente especÃ­fico!            â”‚
â”‚   AND is_active = true                                              â”‚
â”‚                                                                     â”‚
â”‚ Agent Config Loaded:                                                â”‚
â”‚ {                                                                   â”‚
â”‚   agent_id: "sdr",                                                  â”‚
â”‚   agent_name: "Lucas - SDR",                                        â”‚
â”‚   system_prompt: "VocÃª Ã© Lucas, SDR agressivo focado em...",       â”‚
â”‚   llm_provider: "google",                                           â”‚
â”‚   llm_model: "gemini-2.0-flash-exp",                                â”‚
â”‚   tools_enabled: ["rag", "calendar_google", "crm_pipedrive"],      â”‚
â”‚   rag_namespace: "acme-corp-sdr-rag",    â† Namespace do agente     â”‚
â”‚   buffer_delay: 2,                                                  â”‚
â”‚   channels: ["whatsapp_vendas", "instagram"]                       â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fase 2: Buffer & Context Building
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. BUFFER MANAGEMENT (Redis DB-0)                                  â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ Key: buffer:acme-corp:5521999999999@s.whatsapp.net                 â”‚
â”‚                                                                     â”‚
â”‚ CenÃ¡rio 1: Buffer NÃƒO existe                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ LPUSH nova mensagem                                       â”‚      â”‚
â”‚ â”‚ EXPIRE buffer_delay (2 segundos)                          â”‚      â”‚
â”‚ â”‚ â†’ AGUARDAR mais mensagens                                 â”‚      â”‚
â”‚ â”‚ â† RETORNAR 202 Accepted                                   â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚ CenÃ¡rio 2: Buffer existe (mensagens mÃºltiplas)                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ Mensagem 1: "OlÃ¡"                    (t=0s)               â”‚      â”‚
â”‚ â”‚ Mensagem 2: "Quero saber de preÃ§os"  (t=1s) â† Buffer      â”‚      â”‚
â”‚ â”‚ Mensagem 3: "Do plano Pro"           (t=2s) â† Processa!   â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚ LRANGE buffer:... 0 -1  â†’ Ler todas                                â”‚
â”‚ DEL buffer:...          â†’ Limpar                                   â”‚
â”‚                                                                     â”‚
â”‚ Combined: "OlÃ¡\nQuero saber de preÃ§os\nDo plano Pro"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. LOAD MEMORY & HISTORY (Redis DB-1)                              â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ A) HGETALL memory:acme-corp:5521999999999@s.whatsapp.net           â”‚
â”‚    {                                                                â”‚
â”‚      summary: "Lead interessado em plano Pro. Empresa 50 pessoas", â”‚
â”‚      lead_stage: "engaged",                                         â”‚
â”‚      interaction_count: 8,                                          â”‚
â”‚      last_interaction: "2025-11-05T10:00:00Z"                       â”‚
â”‚    }                                                                â”‚
â”‚                                                                     â”‚
â”‚ B) LRANGE history:acme-corp:5521999999999... 0 19 (Ãºltimas 20)     â”‚
â”‚    [                                                                â”‚
â”‚      {role: "user", content: "Oi, tudo bem?"},                     â”‚
â”‚      {role: "assistant", content: "OlÃ¡! Tudo Ã³timo..."},           â”‚
â”‚      {role: "user", content: "Fale sobre seus planos"},            â”‚
â”‚      {role: "assistant", content: "Temos 3 planos..."},            â”‚
â”‚      ...                                                            â”‚
â”‚    ]                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. BUILD CONTEXT WINDOW                                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ messages = [                                                        â”‚
â”‚   {                                                                 â”‚
â”‚     role: "system",                                                 â”‚
â”‚     content: "VocÃª Ã© Lucas, SDR da Acme Corp..."                   â”‚
â”‚   },                                                                â”‚
â”‚   {                                                                 â”‚
â”‚     role: "system",                                                 â”‚
â”‚     content: "Contexto: Lead interessado em plano Pro..."          â”‚
â”‚   },                                                                â”‚
â”‚   ...histÃ³rico de 20 mensagens anteriores,                         â”‚
â”‚   {                                                                 â”‚
â”‚     role: "user",                                                   â”‚
â”‚     content: "OlÃ¡\nQuero saber de preÃ§os\nDo plano Pro"            â”‚
â”‚   }                                                                 â”‚
â”‚ ]                                                                   â”‚
â”‚                                                                     â”‚
â”‚ tools = [                                                           â”‚
â”‚   {                                                                 â”‚
â”‚     type: "function",                                               â”‚
â”‚     function: {                                                     â”‚
â”‚       name: "rag_search",                                           â”‚
â”‚       description: "Busca na base de conhecimento...",             â”‚
â”‚       parameters: {...}                                             â”‚
â”‚     }                                                               â”‚
â”‚   },                                                                â”‚
â”‚   {function: "calendar_create", ...}                                â”‚
â”‚ ]                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Estimated tokens: ~4,500                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fase 3: LLM Processing (com MÃ­dia Output)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. CALL LLM - First Pass                                            â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ Provider: Google Vertex AI                                          â”‚
â”‚ Model: gemini-2.0-flash-exp                                         â”‚
â”‚ Endpoint: .../publishers/google/models/gemini-2.0-flash-exp:gen... â”‚
â”‚                                                                     â”‚
â”‚ Request:                                                            â”‚
â”‚ {                                                                   â”‚
â”‚   contents: [...],  // Suporta multimodal (texto + imagem + vÃ­deo) â”‚
â”‚   systemInstruction: {...},                                         â”‚
â”‚   tools: [                                                          â”‚
â”‚     {function: {name: "rag_search", ...}},                          â”‚
â”‚     {function: {name: "calendar_create", ...}},                     â”‚
â”‚     {function: {name: "image_generate", ...}},  // âœ¨ NOVO          â”‚
â”‚     {function: {name: "tts_generate", ...}}     // âœ¨ NOVO          â”‚
â”‚   ],                                                                â”‚
â”‚   generationConfig: {                                               â”‚
â”‚     temperature: 0.7,                                               â”‚
â”‚     topP: 0.95,                                                     â”‚
â”‚     maxOutputTokens: 2048                                           â”‚
â”‚   }                                                                 â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ â”‚ LLM Response (com function calls):      â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚ "Para lhe dar informaÃ§Ãµes precisas..."  â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚ tool_calls: [                           â”‚                        â”‚
â”‚ â”‚   {                                     â”‚                        â”‚
â”‚ â”‚     id: "call_abc123",                  â”‚                        â”‚
â”‚ â”‚     function: {                         â”‚                        â”‚
â”‚ â”‚       name: "rag_search",               â”‚                        â”‚
â”‚ â”‚       arguments: {                      â”‚                        â”‚
â”‚ â”‚         query: "preÃ§o plano pro",       â”‚                        â”‚
â”‚ â”‚         top_k: 5                        â”‚                        â”‚
â”‚ â”‚       }                                 â”‚                        â”‚
â”‚ â”‚     }                                   â”‚                        â”‚
â”‚ â”‚   }                                     â”‚                        â”‚
â”‚ â”‚ ]                                       â”‚                        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â”‚ Tokens: 4,234 input + 156 output = 4,390 total                     â”‚
â”‚ Cost: $0.000317 + $0.000047 = $0.000364 USD                        â”‚
â”‚ Latency: 847ms                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. EXECUTE TOOLS (Suporte a MÃ­dia)                                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ Tool: rag_search (exemplo padrÃ£o)                                   â”‚
â”‚ Args: {query: "preÃ§o plano pro", top_k: 5}                          â”‚
â”‚                                                                     â”‚
â”‚ [... Processo RAG completo como antes ...]                         â”‚
â”‚                                                                     â”‚
â”‚ Tool Result: "[Fonte: Tabela_Precos_2025.pdf]..."                  â”‚
â”‚                                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚ âœ¨ Tool: image_generate (NOVO)                                      â”‚
â”‚ Args: {                                                             â”‚
â”‚   prompt: "grÃ¡fico comparativo planos starter vs pro",             â”‚
â”‚   size: "1024x1024",                                                â”‚
â”‚   style: "professional"                                             â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ A) Call Imagen 3.0 API (Google Vertex AI)             â”‚        â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
â”‚ â”‚ POST .../publishers/google/models/imagen-3.0-...       â”‚        â”‚
â”‚ â”‚ {                                                       â”‚        â”‚
â”‚ â”‚   prompt: "professional comparison chart showing...",  â”‚        â”‚
â”‚ â”‚   numberOfImages: 1,                                    â”‚        â”‚
â”‚ â”‚   aspectRatio: "1:1"                                    â”‚        â”‚
â”‚ â”‚ }                                                       â”‚        â”‚
â”‚ â”‚                                                         â”‚        â”‚
â”‚ â”‚ Response: {images: [{imageBytes: "base64..."}]}        â”‚        â”‚
â”‚ â”‚ Latency: 8,234ms (~8s)                                  â”‚        â”‚
â”‚ â”‚ Cost: $0.04 USD                                         â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ B) Upload to Supabase Storage                          â”‚        â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
â”‚ â”‚ Bucket: media                                           â”‚        â”‚
â”‚ â”‚ Path: acme-corp/sdr/generated/img_20251106_1234.png    â”‚        â”‚
â”‚ â”‚ URL: https://xxx.supabase.co/storage/v1/object/...     â”‚        â”‚
â”‚ â”‚                                                         â”‚        â”‚
â”‚ â”‚ Latency: 456ms                                          â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚ Tool Result: {                                                      â”‚
â”‚   success: true,                                                    â”‚
â”‚   image_url: "https://xxx.supabase.co/.../img_1234.png",           â”‚
â”‚   cost_usd: 0.04                                                    â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚ âœ¨ Tool: tts_generate (NOVO)                                        â”‚
â”‚ Args: {                                                             â”‚
â”‚   text: "O Plano Pro custa R$ 497 por mÃªs...",                     â”‚
â”‚   voice: "pt-BR-Wavenet-A"                                          â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ A) Call Google Cloud TTS API                           â”‚        â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
â”‚ â”‚ POST .../v1/text:synthesize                            â”‚        â”‚
â”‚ â”‚ {                                                       â”‚        â”‚
â”‚ â”‚   input: {text: "O Plano Pro..."},                     â”‚        â”‚
â”‚ â”‚   voice: {                                              â”‚        â”‚
â”‚ â”‚     languageCode: "pt-BR",                             â”‚        â”‚
â”‚ â”‚     name: "pt-BR-Wavenet-A"                            â”‚        â”‚
â”‚ â”‚   },                                                    â”‚        â”‚
â”‚ â”‚   audioConfig: {audioEncoding: "OGG_OPUS"}             â”‚        â”‚
â”‚ â”‚ }                                                       â”‚        â”‚
â”‚ â”‚                                                         â”‚        â”‚
â”‚ â”‚ Response: {audioContent: "base64..."}                   â”‚        â”‚
â”‚ â”‚ Duration: ~12 segundos                                  â”‚        â”‚
â”‚ â”‚ Latency: 1,234ms                                        â”‚        â”‚
â”‚ â”‚ Cost: $0.0019 USD (119 chars Ã— $16/1M)                 â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ B) Upload to Supabase Storage                          â”‚        â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
â”‚ â”‚ Bucket: media                                           â”‚        â”‚
â”‚ â”‚ Path: acme-corp/sdr/generated/audio_20251106_1234.ogg  â”‚        â”‚
â”‚ â”‚ URL: https://xxx.supabase.co/storage/v1/object/...     â”‚        â”‚
â”‚ â”‚                                                         â”‚        â”‚
â”‚ â”‚ Latency: 234ms                                          â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚ Tool Result: {                                                      â”‚
â”‚   success: true,                                                    â”‚
â”‚   audio_url: "https://xxx.supabase.co/.../audio_1234.ogg",         â”‚
â”‚   duration_seconds: 12,                                             â”‚
â”‚   cost_usd: 0.0019                                                  â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. CALL LLM - Second Pass (com tool results + mÃ­dia)              â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ messages = [                                                        â”‚
â”‚   ...previous messages,                                             â”‚
â”‚   {                                                                 â”‚
â”‚     role: "assistant",                                              â”‚
â”‚     content: "Para lhe dar informaÃ§Ãµes precisas...",               â”‚
â”‚     tool_calls: [                                                   â”‚
â”‚       {id: "call_abc123", function: "rag_search", ...},             â”‚
â”‚       {id: "call_def456", function: "image_generate", ...},         â”‚
â”‚       {id: "call_ghi789", function: "tts_generate", ...}            â”‚
â”‚     ]                                                               â”‚
â”‚   },                                                                â”‚
â”‚   {                                                                 â”‚
â”‚     role: "tool",                                                   â”‚
â”‚     tool_call_id: "call_abc123",                                    â”‚
â”‚     name: "rag_search",                                             â”‚
â”‚     content: "[Fonte: Tabela_Precos...]..."                        â”‚
â”‚   },                                                                â”‚
â”‚   {                                                                 â”‚
â”‚     role: "tool",                                                   â”‚
â”‚     tool_call_id: "call_def456",                                    â”‚
â”‚     name: "image_generate",                                         â”‚
â”‚     content: '{"success":true,"image_url":"https://..."}'           â”‚
â”‚   },                                                                â”‚
â”‚   {                                                                 â”‚
â”‚     role: "tool",                                                   â”‚
â”‚     tool_call_id: "call_ghi789",                                    â”‚
â”‚     name: "tts_generate",                                           â”‚
â”‚     content: '{"success":true,"audio_url":"https://..."}'           â”‚
â”‚   }                                                                 â”‚
â”‚ ]                                                                   â”‚
â”‚                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ â”‚ Final LLM Response:                     â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚ "Ã“tima escolha! O Plano Pro custa      â”‚                        â”‚
â”‚ â”‚  R$ 497/mÃªs e inclui:                   â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚  â€¢ 3 agentes de IA personalizados       â”‚                        â”‚
â”‚ â”‚  â€¢ AtÃ© 20 mil mensagens/mÃªs             â”‚                        â”‚
â”‚ â”‚  â€¢ Dashboard avanÃ§ado com analytics     â”‚                        â”‚
â”‚ â”‚  â€¢ Acesso Ã  API                         â”‚                        â”‚
â”‚ â”‚  â€¢ Suporte prioritÃ¡rio                  â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚  Criei um grÃ¡fico comparativo e uma     â”‚                        â”‚
â”‚ â”‚  mensagem de voz com os detalhes!"      â”‚                        â”‚
â”‚ â”‚                                         â”‚                        â”‚
â”‚ â”‚ âœ¨ attachments: [                       â”‚                        â”‚
â”‚ â”‚   {                                     â”‚                        â”‚
â”‚ â”‚     type: "image",                      â”‚                        â”‚
â”‚ â”‚     url: "https://...img_1234.png",     â”‚                        â”‚
â”‚ â”‚     caption: "ComparaÃ§Ã£o Starter vs Pro"â”‚                        â”‚
â”‚ â”‚   },                                    â”‚                        â”‚
â”‚ â”‚   {                                     â”‚                        â”‚
â”‚ â”‚     type: "audio",                      â”‚                        â”‚
â”‚ â”‚     url: "https://...audio_1234.ogg"    â”‚                        â”‚
â”‚ â”‚   }                                     â”‚                        â”‚
â”‚ â”‚ ]                                       â”‚                        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â”‚ Tokens: 4,889 input + 267 output = 5,156 total                     â”‚
â”‚ Cost: $0.000367 + $0.000080 = $0.000447 USD                        â”‚
â”‚ Latency: 1,345ms                                                    â”‚
â”‚                                                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                          â”‚
â”‚ TOTAL COST: $0.04267 USD (LLM + RAG + Imagen + TTS)                â”‚
â”‚ TOTAL LATENCY: 12,350ms (~12.3 seconds - Imagen Ã© lento)           â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fase 4: Persistence & Response (com MÃ­dia)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. SAVE MEMORY & HISTORY (Redis DB-1)                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ A) Save History (Ãºltimas 50 msgs)                                  â”‚
â”‚    LPUSH history:acme-corp:... '{"role":"user","content":"..."}'   â”‚
â”‚    LPUSH history:acme-corp:... '{"role":"assistant",...}'          â”‚
â”‚    LTRIM history:acme-corp:... 0 49  â† Manter sÃ³ 50                â”‚
â”‚    EXPIRE history:acme-corp:... 604800  â† 7 dias                   â”‚
â”‚                                                                     â”‚
â”‚ B) Update Memory                                                    â”‚
â”‚    HINCRBY memory:acme-corp:... interaction_count 1  â†’ 9           â”‚
â”‚    HSET memory:acme-corp:... last_interaction "2025-11-06T..."     â”‚
â”‚    # Se 10Âª interaÃ§Ã£o â†’ gerar summary                              â”‚
â”‚    EXPIRE memory:acme-corp:... 2592000  â† 30 dias                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. LOG EXECUTION (Supabase)                                        â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ INSERT INTO agent_executions (                                      â”‚
â”‚   client_id,           â†’ 'acme-corp'                                â”‚
â”‚   conversation_id,     â†’ '5521999999999@s.whatsapp.net'             â”‚
â”‚   user_message,        â†’ 'OlÃ¡\nQuero saber...'                     â”‚
â”‚   agent_response,      â†’ 'Ã“tima escolha! O Plano Pro...'           â”‚
â”‚   llm_provider,        â†’ 'google'                                   â”‚
â”‚   llm_model,           â†’ 'gemini-2.0-flash-exp'                     â”‚
â”‚   tools_called,        â†’ '[{"tool":"rag_search",...}]'::jsonb       â”‚
â”‚   total_latency_ms,    â†’ 2391                                       â”‚
â”‚   llm_latency_ms,      â†’ 1970                                       â”‚
â”‚   rag_latency_ms,      â†’ 421                                        â”‚
â”‚   prompt_tokens,       â†’ 8857                                       â”‚
â”‚   completion_tokens,   â†’ 390                                        â”‚
â”‚   total_tokens,        â†’ 9247                                       â”‚
â”‚   total_cost_usd,      â†’ 0.000781                                   â”‚
â”‚   status,              â†’ 'success'                                  â”‚
â”‚   n8n_execution_id     â†’ 'abc-123-def'                              â”‚
â”‚ );                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. UPDATE USAGE (Supabase)                                         â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ SELECT increment_client_usage(                                      â”‚
â”‚   p_client_id := 'acme-corp',                                       â”‚
â”‚   p_tokens_in := 8857,                                              â”‚
â”‚   p_tokens_out := 390,                                              â”‚
â”‚   p_images := 0,                                                    â”‚
â”‚   p_rag_searches := 1,                                              â”‚
â”‚   p_cost_usd := 0.000781                                            â”‚
â”‚ );                                                                  â”‚
â”‚                                                                     â”‚
â”‚ Result (tabela client_usage):                                       â”‚
â”‚ {                                                                   â”‚
â”‚   client_id: 'acme-corp',                                           â”‚
â”‚   billing_period: '2025-11-01',                                     â”‚
â”‚   total_requests: 1524 (+1),                                        â”‚
â”‚   total_tokens: 11,234,567 (+9247),                                 â”‚
â”‚   rag_searches: 856 (+1),                                           â”‚
â”‚   total_cost_usd: 11.23 (+0.000781)                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. SEND TO CHANNEL                                                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ Channel: WhatsApp (Evolution API)                                   â”‚
â”‚                                                                     â”‚
â”‚ POST https://evolution.acme.com.br/message/sendText/acme-whatsapp  â”‚
â”‚ {                                                                   â”‚
â”‚   "number": "5521999999999@s.whatsapp.net",                         â”‚
â”‚   "text": "Ã“tima escolha! O Plano Pro custa R$ 497/mÃªs..."         â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response: 200 OK                                                    â”‚
â”‚ {                                                                   â”‚
â”‚   "key": {"id": "xyz789"},                                          â”‚
â”‚   "status": "pending"                                               â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Latency: 234ms                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                              âœ¨ FIM DO FLUXO âœ¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO                            â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ Client: acme-corp                                                   â”‚
â”‚ Conversation: 5521999999999@s.whatsapp.net                          â”‚
â”‚ Channel: WhatsApp                                                   â”‚
â”‚                                                                     â”‚
â”‚ LatÃªncias:                                                          â”‚
â”‚ â€¢ Webhook â†’ LLM First:       847ms                                  â”‚
â”‚ â€¢ RAG Search:                421ms                                  â”‚
â”‚ â€¢ LLM Second:              1,123ms                                  â”‚
â”‚ â€¢ Save & Send:               234ms                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚ â€¢ TOTAL:                   2,625ms  (~2.6 segundos)                 â”‚
â”‚                                                                     â”‚
â”‚ Custos:                                                             â”‚
â”‚ â€¢ LLM (2 calls):        $0.000781                                   â”‚
â”‚ â€¢ Embedding:            $0.000003                                   â”‚
â”‚ â€¢ RAG Search:           $0.000000  (incluÃ­do no DB)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚ â€¢ TOTAL:                $0.000784  (~0.08 centavos de USD)          â”‚
â”‚                                                                     â”‚
â”‚ Tokens:                                                             â”‚
â”‚ â€¢ Prompt:                    8,857                                  â”‚
â”‚ â€¢ Completion:                  390                                  â”‚
â”‚ â€¢ TOTAL:                     9,247                                  â”‚
â”‚                                                                     â”‚
â”‚ Tools Executed:                                                     â”‚
â”‚ â€¢ rag_search (1x)                                                   â”‚
â”‚                                                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. SEND TO CHANNEL (com MÃ­dia)                                    â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                                     â”‚
â”‚ Channel: WhatsApp (Evolution API / Cloud API)                      â”‚
â”‚                                                                     â”‚
â”‚ âœ¨ A) Enviar Texto                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ POST https://evolution.acme.com.br/message/sendText/acme-whatsapp  â”‚
â”‚ {                                                                   â”‚
â”‚   "number": "5521999999999@s.whatsapp.net",                         â”‚
â”‚   "text": "Ã“tima escolha! O Plano Pro custa R$ 497/mÃªs..."         â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ âœ¨ B) Enviar Imagem                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ POST https://evolution.acme.com.br/message/sendMedia/acme-whatsapp â”‚
â”‚ {                                                                   â”‚
â”‚   "number": "5521999999999@s.whatsapp.net",                         â”‚
â”‚   "mediatype": "image",                                             â”‚
â”‚   "media": "https://xxx.supabase.co/.../img_1234.png",             â”‚
â”‚   "caption": "ComparaÃ§Ã£o Starter vs Pro"                           â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Latency: 456ms                                                      â”‚
â”‚                                                                     â”‚
â”‚ âœ¨ C) Enviar Ãudio                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ POST https://evolution.acme.com.br/message/sendMedia/acme-whatsapp â”‚
â”‚ {                                                                   â”‚
â”‚   "number": "5521999999999@s.whatsapp.net",                         â”‚
â”‚   "mediatype": "audio",                                             â”‚
â”‚   "media": "https://xxx.supabase.co/.../audio_1234.ogg"            â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Latency: 523ms                                                      â”‚
â”‚                                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚ Alternative: Chatwoot API (se canal = chatwoot)                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ POST https://chatwoot.com/api/v1/accounts/123/conversations/456/... â”‚
â”‚ {                                                                   â”‚
â”‚   "content": "Ã“tima escolha!...",                                   â”‚
â”‚   "message_type": "outgoing",                                       â”‚
â”‚   "attachments": [                                                  â”‚
â”‚     "https://xxx.supabase.co/.../img_1234.png",                     â”‚
â”‚     "https://xxx.supabase.co/.../audio_1234.ogg"                    â”‚
â”‚   ]                                                                 â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Response: 200 OK                                                    â”‚
â”‚ {                                                                   â”‚
â”‚   "id": 789,                                                        â”‚
â”‚   "content": "...",                                                 â”‚
â”‚   "attachments": [                                                  â”‚
â”‚     {                                                               â”‚
â”‚       "id": 1,                                                      â”‚
â”‚       "file_type": "image",                                         â”‚
â”‚       "data_url": "https://..."                                     â”‚
â”‚     },                                                              â”‚
â”‚     {                                                               â”‚
â”‚       "id": 2,                                                      â”‚
â”‚       "file_type": "audio",                                         â”‚
â”‚       "data_url": "https://..."                                     â”‚
â”‚     }                                                               â”‚
â”‚   ]                                                                 â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Status: âœ… SUCCESS (Texto + Imagem + Ãudio enviados)               â”‚
â”‚                                                                     â”‚
â”‚ UsuÃ¡rio Recebe:                                                     â”‚
â”‚ ğŸ“± [Texto] "Ã“tima escolha! O Plano Pro..."                         â”‚
â”‚ ğŸ“± [Imagem] GrÃ¡fico comparativo                                    â”‚
â”‚ ğŸ“± [Ãudio 12s] Mensagem de voz explicativa                         â”‚
â”‚                                                                     â”‚
â”‚ UsuÃ¡rio Satisfeito: ğŸ˜ŠğŸ‰                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Estrutura de Dados

### Redis DB-0 (Buffer & Queues)
```
buffer:acme-corp:5521999999999@...     [List]     TTL: 2s
â”œâ”€ [0] {"timestamp":"...","message":"OlÃ¡","from":"..."}
â”œâ”€ [1] {"timestamp":"...","message":"Quero saber de preÃ§os"}
â””â”€ [2] {"timestamp":"...","message":"Do plano Pro"}

queue:rag_ingestion:high               [List]     Persistent
â”œâ”€ {"job_id":"abc","client_id":"...","source_type":"pdf",...}
â””â”€ ...

ratelimit:acme-corp:minute             [String]   TTL: 60s
â””â”€ "45"
```

### Redis DB-1 (Memory & Cache)
```
memory:acme-corp:5521999999999@...     [Hash]     TTL: 30 days
â”œâ”€ summary: "Lead interessado em plano Pro..."
â”œâ”€ lead_stage: "engaged"
â”œâ”€ interaction_count: "9"
â”œâ”€ first_contact: "2025-11-04T..."
â””â”€ last_interaction: "2025-11-06T..."

history:acme-corp:5521999999999@...    [List]     TTL: 7 days
â”œâ”€ [0] {"role":"user","content":"..."}         â† Mais recente
â”œâ”€ [1] {"role":"assistant","content":"..."}
â”œâ”€ ...
â””â”€ [49] {"role":"user","content":"..."}        â† Mais antiga

embedding:sha256(preÃ§o plano pro)      [String]   TTL: 7 days
â””â”€ "[0.123, -0.456, ..., 0.789]"
```

### Supabase (PostgreSQL)
```
clients                                 [Table]
â”œâ”€ client_id: "acme-corp"
â”œâ”€ system_prompt: "VocÃª Ã© Lucas..."
â”œâ”€ llm_provider: "google"
â”œâ”€ llm_model: "gemini-2.0-flash-exp"
â”œâ”€ tools_enabled: ["rag", "calendar_google"]
â”œâ”€ rag_namespace: "acme-corp-rag"
â””â”€ rate_limits: {"requests_per_minute": 60, ...}

rag_documents                           [Table]
â”œâ”€ client_id: "acme-corp"
â”œâ”€ rag_namespace: "acme-corp-rag"
â”œâ”€ chunk_text: "Plano Pro: R$ 497/mÃªs..."
â”œâ”€ embedding: [0.234, -0.567, ...] (768 dims)
â”œâ”€ source_name: "Tabela_Precos_2025.pdf"
â””â”€ similarity: 0.92 (calculado em tempo de query)

agent_executions                        [Table]
â”œâ”€ client_id: "acme-corp"
â”œâ”€ user_message: "OlÃ¡\nQuero saber de preÃ§os..."
â”œâ”€ agent_response: "Ã“tima escolha! O Plano Pro..."
â”œâ”€ total_latency_ms: 2625
â”œâ”€ total_cost_usd: 0.000784
â”œâ”€ tools_called: [{"tool":"rag_search",...}]
â””â”€ status: "success"

client_usage                            [Table]
â”œâ”€ client_id: "acme-corp"
â”œâ”€ billing_period: "2025-11-01"
â”œâ”€ total_requests: 1524
â”œâ”€ total_tokens: 11234567
â”œâ”€ total_cost_usd: 11.23
â””â”€ rag_searches: 856
```

---

## ğŸ¯ Casos de Uso Visuais

### Caso 1: Atendimento Simples (Sem Tools)
```
User: "Oi, tudo bem?"
  â†“
WF 0 â†’ LLM (1 call)
  â†“
Agent: "OlÃ¡! Tudo Ã³timo! Como posso ajudar?"

LatÃªncia: ~800ms
Custo: $0.0003
```

### Caso 2: Consulta RAG
```
User: "Qual o preÃ§o do Plano Pro?"
  â†“
WF 0 â†’ LLM â†’ tool_call: rag_search
  â†“
RAG â†’ embedding + search â†’ 5 chunks
  â†“
LLM â†’ resposta com dados do RAG
  â†“
Agent: "O Plano Pro custa R$ 497/mÃªs e inclui..."

LatÃªncia: ~2.5s
Custo: $0.0008
```

### Caso 3: Agendamento (RAG + Calendar)
```
User: "Quero agendar uma demo"
  â†“
WF 0 â†’ LLM â†’ tool_calls: [rag_search, calendar_create]
  â†“
RAG â†’ busca disponibilidade
Calendar â†’ cria evento
  â†“
LLM â†’ confirmaÃ§Ã£o
  â†“
Agent: "Agendei para 10/11 Ã s 14h. Enviei convite!"

LatÃªncia: ~3.5s
Custo: $0.0012
```

---

**Autor**: Victor Castro - Evolute Digital  
**Data**: 06/11/2025  
**VersÃ£o**: 1.0.0
